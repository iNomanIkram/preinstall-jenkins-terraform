#cloud-config
package_update: true


bootcmd:
    - mkdir -p /jenkins_data/init.groovy.d/
    - chmod -R 777 /jenkins_data

write_files:
    -   encoding: b64
        content: ${BASIC_SECURITY_GROOVY}
        path: /jenkins_data/init.groovy.d/basic-security.groovy

runcmd:
    -   |
        apt-get update -y
        apt-get install -y \
            apt-transport-https \
            ca-certificates \
            curl \
            gnupg \
            lsb-release

        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
        echo \
            "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
            $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null


        apt-get update -y
        apt-get -y install docker-ce docker-ce-cli containerd.io 
        usermod -a -G docker ubuntu
        service docker start
        systemctl enable docker

        useradd -m -s /bin/bash jenkins
        chown -R jenkins:jenkins /jenkins_data
        docker run --name jenkins -p 8080:8080 -p 50000:50000 -v /jenkins_data/:/var/jenkins_home/ ${JENKINS_DOCKER_IMAGE}
